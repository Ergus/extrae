\chapter{\TRACE XML configuration file}\label{cha:XML}

\TRACE is configured through a XML file that is set through the {\tt MPTRACE\_CONFIG\_FILE} environment variable. The included examples provide several XML files to serve as a basis for the end user. There are four XML files:
\begin{itemize}
 \item {\tt mpitrace.xml} Exemplifies all the options available to set up in the configuration file. We will discuss below all the sections and options available. It is also available on this document on appendix \ref{cha:wholeXML}.
 \item {\tt mpitrace\_explained.xml} The same as the above with some comments on each section.
 \item {\tt summarized\_trace\_basic.xml} A small example for gathering information of MPI and OpenMP information with some performace counters and calling information at each MPI call.
 \item {\tt detailed\_trace\_basic.xml} A small example for gathering a summarized information of MPI and OpenMP parallel paradigms.
\end{itemize}

Please note that most of the nodes present in the XML file have an {\tt enabled} attribute that allows turning on and off some parts of the instrumentation mechanism. For example, {\tt <mpi enabled="yes">} means MPI instrumentation is enabled and process all the contained XML subnodes, if any; whether {\tt <mpi enabled="no">} means to skip gathering MPI information and do not process XML subnodes.

Each section points which environment variables could be used if the tracing package lacks XML support. See appendix \ref{cha:EnvVar} for the entire list.

\section{XML Section: Trace configuration}\label{sec:XMLSectionTraceConfiguration}

The basic trace behavior is determined in the first part of the XML and {\bf contains} all of the remaining options. It looks like:

\input{XML/config.xml}

The {\tt <?xml version='1.0'?>} is mandatory for all XML files. Don't touch this. The available tunable options are under the {\tt <trace>} node:
\begin{itemize}
 \item {\tt enabled} Set to {\tt "yes"} if you want to generate tracefiles.
 \item {\tt home} Set to where your instrumentation package is installed. Usually it points to the same location that {\tt MPITRACE\_HOME} environment variable.
 \item {\tt initial-mode} Available options
  \begin{itemize}
   \item {\tt detail} Provides detailed information of the tracing.
   \item {\tt bursts} Provides summarized information of the tracing. This mode removes most of the information present in the detailed traces (like OpenMP and MPI calls among others) and only produces information for computation bursts.
  \end{itemize} 
 \item {\tt type} Available options
  \begin{itemize}
   \item {\tt paraver} The intermediate files are meant to generate Paraver tracefiles.
   \item {\tt dimemas} The intermediate files are meant to generate Dimemas tracefiles.
  \end{itemize}
 \item {\tt xml-parser-id} This is used to check whether the XML parsing scheme and the file scheme match or not.
\end{itemize}

\graybox{See {\bf MPITRACE\_ON}, {\bf MPITRACE\_HOME}, {\bf MPITRACE\_INITIAL\_MODE} and {\bf MPITRACE\_TRACE\_TYPE} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: MPI}\label{sec:XMLSectionMPI}

The MPI configuration part is nested in the config file (see section \ref{sec:XMLSectionTraceConfiguration}) and its nodes are the following:

\input{XML/mpi.xml}

MPI calls can gather performance information at the begin and end of MPI calls. To activate this behavior, just set to yes the attribute of the nested {\tt <counters>} node.

\graybox{See {\bf MPITRACE\_DISABLE\_MPI} and {\bf MPITRACE\_MPI\_COUNTERS\_ON} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: PACX}\label{sec:XMLSectionPACX}

The PACX configuration part is nested in the config file (see section \ref{sec:XMLSectionTraceConfiguration}) and its nodes are the following:

\input{XML/pacx.xml}

PACX calls can gather performance information at the begin and end of PACX calls. To activate this behavior, just set to yes the attribute of the nested {\tt <counters>} node.

\graybox{See {\bf MPITRACE\_DISABLE\_PACX} and {\bf MPITRACE\_PACX\_COUNTERS\_ON} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: OpenMP}\label{sec:XMLSectionOpenMP}

The OpenMP configuration part is nested in the config file (see section \ref{sec:XMLSectionTraceConfiguration}) and its nodes are the following:

\input{XML/openmp.xml}

The tracing package allows to gather information of some OpenMP runtimes and outlined routines. In addition to that, the user can also enable gathering information of locks and also gathering performance counters in all of these routines. This is achieved by modifying the enabled attribute of the {\tt <locks>} and {\tt <counters>}, respectively.

\graybox{See {\bf MPITRACE\_DISABLE\_OMP}, {\bf MPTRACE\_OMP\_LOCKS} and {\bf MPITRACE\_OMP\_COUNTERS\_ON} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: CELL}\label{sec:XMLcell}

The Cell configuration part is only parsed for tracing packages suited for the Cell architecture, and as the rest of sections it is nested in the config file (see section \ref{sec:XMLSectionTraceConfiguration}). The available nodes only affect the SPE side, and they are:

\input{XML/cell.xml}

\begin{itemize}
 \item {\tt spu-file-size} Limits the resulting intermediate trace file for each SPE thread that has been instrumented.
 \item {\tt spu-buffer-size} Specifies the number of events contained in the buffer on the SPE side. Remember that memory is very scarce on the SPE, so setting a high value can exhaust all memory.
 \item {\tt spu-dma-channel} Chooses which {DMA} channel will be used to perform the intermediate trace files transfers to the PPE side.
\end{itemize}

\graybox{See {\bf MPITRACE\_SPU\_FILE\_SIZE}, {\bf MPITRACE\_SPU\_BUFFER\_SIZE} and {\bf MPITRACE\_SPU\_DMA\_CHANNEL} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: Callers}\label{sec:XMLSectionCallers}

\input{XML/callers.xml}

Callers are the routine addresses present in the process stack at any given moment during the application run. Callers can be used to link the tracefile with the source code of the application.

The instrumentation library can collect a partial view of those addresses during the instrumentation. Such collected addresses are translated by the merging process if the correspondent parameter is given and the application has been compiled and linked with debug information.

There are three points where the instrumentation can gather this information:

\begin{itemize}
 \item Entry of MPI calls
 \item Entry of PACX calls
 \item Sampling points {\em (if sampling is available in the tracing package)}
\end{itemize}

The user can choose which addresses to save in the trace (starting from 1, which is the closest point to the MPI call or sampling point) specifying several stack levels by separating them by commas or using the hyphen symbol.

\graybox{See {\bf MPITRACE\_MPI\_CALLER} and {\bf MPITRACE\_PACX\_CALLER} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: User functions}\label{sec:XMLSectionUF}

To be written.

\section{XML Section: Performance counters}\label{sec:XMLSectionPerformanceCounters}

The instrumentation library can be compiled with support for collecting performance metrics of different components available on the system. These components include:

\begin{itemize}
 \item Processor performance counters. Such access is granted by PAPI\footnote{More information available on their website \url{http://icl.cs.utk.edu/papi}. \TRACE requires PAPI 3.x at least.} or PMAPI\footnote{PMAPI is only available for AIX operating system, and it is on the base operating system since AIX5.3. \TRACE requires AIX 5.3 at least.}
 \item Network performance counters. {\em (Only available in systems with Myrinet GM/MX networks).}
 \item Operating system accounts.
\end{itemize}

Here is an example of the counters section in the XML configuration file:

\input{XML/counters.xml}

\graybox{See {\bf MPTRACE\_COUNTERS}, {\bf MPITRACE\_NETWORK\_COUNTERS} and {\bf MPTRACE\_RUSAGE} environment variables in appendix \ref{cha:EnvVar}.}

\subsection{Processor performance counters}\label{subsec:ProcessorPerformanceCounters}

Processor performance counters are configured in the {\tt <cpu>} nodes. The user can configure many sets in the {\tt <cpu>} node using the {\tt <set>} node, but just one set will be used at any given time in a specific task. The {\tt <cpu>} node supports the {\tt tarting-set-distribution} attribute with the following accepted values:

\begin{itemize}
 \item {\tt number} ({\em in range 1..N, where N is the number of configured sets}) All tasks will start using the set specified by number.
 \item {\tt block} Each task will start using the given sets distributed in blocks ({\em i.e.}, if two sets are defined and there are four running tasks: tasks 1 and 2 will use set 1, and tasks 3 and 4 will use set 2).
 \item {\tt cyclic} Each task will start using the given sets distributed cyclically ({\em i.e.}, if two sets are defined and there are four running tasks: tasks 1 and 3 will use, and tasks 2 and 4 will use set 2).
\end{itemize}

Each set contain a list of performance counters to be gathered at different instrumentation points (see sections \ref{sec:XMLSectionMPI}, \ref{sec:XMLSectionOpenMP} and \ref{sec:XMLSectionUF}). If the tracing library is compiled to support PAPI, performance counters must be given using the canonical name (like PAPI\_TOT\_CYC and PAPI\_L1\_DCM), or the PAPI code in hexadecimal format (like 8000003b and 80000000, respectively)\footnote{Some architectures do not allow grouping some performance counters in the same set.}. If the tracing library is compiled to support PMAPI, only one group identifier can be given per set\footnote{Each group contains several performance counters} and can be either the group name (like pm\_basic and pm\_hpmcount1) or the group number (like 6 and 22, respectively). 

In the given example (which refers to PAPI support in the tracing library) two sets are defined. First set will read {PAPI\_TOT\_INS} (total instructions), {PAPI\_TOT\_CYC} (total cycles) and {PAPI\_L1\_DCM} (1st level cache misses). Second set is configured to obtain {PAPI\_TOT\_INS} (total instructions), {PAPI\_TOT\_CYC} (total cycles) and {PAPI\_FP\_INS} (floating point instructions).

Additionally, if the underlying performance library supports sampling mechanisms, each set can be configured to gather information (see section \ref{sec:XMLSectionCallers}) each time the specified counter reaches a specific value. In the given example, the first set is enabled to gather sampling information every 100M cycles. {\bf explicar que el comptador ha d'estar al set}

Furthermore, performance counters can be configured to report accounting on different basis depending on the {\tt domain} attribute specified on each set. Available options are
\begin{itemize}
 \item {\tt kernel} Only counts events ocurred when the application is running in kernel mode.
 \item {\tt user} Only counts events ocurred when the application is running in user-space mode.
 \item {\tt all} Counts events independently of the application running mode.
\end{itemize}

In the given example, first set is configured to count all the events ocurred, while the second one only counts those events ocurred when the application is running in user-space mode.

Finally, the instrumentation can change the active set in a manual and an automatic fashion. To change the active set manually see {\tt OMPItrace\_previous\_hwc\_set} and {\tt OMPItrace\_next\_hwc\_set} API calls in \ref{sec:BasicAPI}. To change automatically the active set two options are allowed: based on time and based on application code. The former mechanism requires adding the attribute {\tt changeat-time} and specify the minimum time\footnote{The following postfixes can be used: n for nanoseconds, u for microseconds, m for milliseconds, s for seconds, M for minutes, H for hours and D for days.} to hold the set. The latter requires adding the attribute {\tt changeat-globalops} with a value. The tracing library will automatically change the active set when the application has executed as many MPI global operations as selected in that attribute. When In any case, if either attribute is set to zero, then the set will not me changed automatically.

\subsection{Network performance counters}\label{subsec:NetworkPerformanceCounters}

Network performance counters are only available on systems with Myrinet GM/MX networks and they are fixed depending on the firmware used. Other systems, like BG/L and BG/P may provide some network performance counters, but they are accessed through the PAPI interface (see section \ref{sec:XMLSectionPerformanceCounters} and {PAPI} documentation).

If {\tt <network>} is enabled the network performance counters appear at the end of the application run, giving a summary for the whole run.

\subsection{Operating system accounting}\label{subsec:OperatingSystemAccounting}

Operating system accounting is obtained through the getrusage(2) system call when {\tt <resource-usage>} is enabled. As network performance counters, they appear at the end of the application run, giving a summary for the whole run.

\section{XML Section: Storage management}\label{sec:XMLSectionStorage}

The instrumentation packages can be instructed on what/where/how produce the intermediate trace files. These are the available options:

\input{XML/storage.xml}

Such options refer to:

\begin{itemize}
 \item {\tt trace-prefix} Sets the intermediate trace file prefix. Its default value is {TRACE}.
 \item {\tt size} Let the user restrict the maximum size (in megabytes) of each resulting intermediate trace file\footnote{This check is done each time the buffer is flushed, so the resulting size of the intermediate trace file depends also on the number of elements contained in the tracing buffer (see section \ref{sec:XMLSectionBuffer}).}.
 \item {\tt temporal-directory} Where the intermediate trace files will be stored during the execution of the application. By default they are stored in the current directory. If the directory does not exist, the instrumentation will try to make it.\\
 \item {\tt final-directory} Where the intermediate trace files will be stored once the execution has been finished. By default they are stored in the current directory. If the directory does not exist, the instrumentation will try to make it.\\
 \item {\tt gather-mpits} If the system does not provide a global filesystem the resulting trace files will be distributed among the computation nodes. Turning on this option will use the underlying communication mechanism ({MPI}) to gather all the intermediate trace files into the root node.
\end{itemize}

\graybox{See {\bf MPTRACE\_PROGRAM\_NAME}, {\bf MPTRACE\_FILE\_SIZE}, {\bf MPTRACE\_DIR}, {\bf MPTRACE\_FINAL\_DIR} and {\bf MPTRACE\_GATHER\_MPITS} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: Buffer management}\label{sec:XMLSectionBuffer}

Modify the buffer management entry to tune the tracing buffer behavior.

\input{XML/buffer.xml}

By, default (even if the enabled attribute is "no") the tracing buffer is set to 150k events (see section \ref{sec:XMLcell} for further information of buffer in the CELL). If {\tt <size>} is enabled the tracing buffer will be set to the number of events indicated by this node. If the circular option is enabled, the buffer will be created as a circular buffer and the buffer will be dumped only once with the last events generated by the tracing package.

\graybox{See {\bf MPTRACE\_BUFFER\_SIZE} environment variable in appendix \ref{cha:EnvVar}.}

\section{XML Section: Trace control}\label{sec:XMLSectionTraceControl}

To be written.

\section{XML Section: Bursts}\label{sec:XMLSectionBursts}

\input{XML/bursts.xml}

If the user enables this option, the instrumentation library will just emit information of computation bursts ({\em i.e.}, not does not trace {MPI} calls, {OpenMP} runtime, and so on). The library will discard all those computation bursts that last less than the selected threshold\footnote{The threshold understands the following postfixes: n for nanoseconds, u for microseconds, m for milliseconds, s for seconds, M for minutes, H for hours and D for days.}. 

In addition to that, when the tracing library is running in burst mode, it computes some statistics of MPI and PACX activity. Such statistics can be dumped in the tracefile by enabling {\tt mpi-statistics} and {\tt pacx-statistics} respectively.

\graybox{See {\bf MPITRACE\_INITIAL\_MODE}, {\bf MPITRACE\_BURST\_THRESHOLD}, {\bf MPITRACE\_MPI\_STATISTICS} and {\bf MPITRACE\_PACX\_STATISTICS} environment variables in appendix \ref{cha:EnvVar}.}

\section{XML Section: Others}\label{sec:XMLSectionOthers}

To be written.
